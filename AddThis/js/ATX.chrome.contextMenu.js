
var ContextMenu={bgPage:chrome.extension.getBackgroundPage(),contextArray:new Array(),init:function(){this._createMenu();},contextMenuItems:function(contextItemId,serviceId){this.contextItemId=contextItemId;this.serviceId=serviceId;},_shareFromContextMenu:function(info,tab){if(["facebook_like","google_plusone"].indexOf(ContextMenu.contextArray[info.menuItemId].serviceId)>-1){var notification=webkitNotifications.createHTMLNotification("ATX.chrome.servicesNotification.html?serviceID="+ContextMenu.contextArray[info.menuItemId].serviceId+"&url="+tab.url);notification.show();}else{var shareObj={targetName:ContextMenu.contextArray[info.menuItemId].serviceId,pub:(typeof(ContextMenu.bgPage.BootLoader.pubIDTabMap[tab.id])!="undefined"&&ContextMenu.bgPage.BootLoader.pubIDTabMap[tab.id]!=null)?ContextMenu.bgPage.BootLoader.pubIDTabMap[tab.id]:"",pageUrl:tab.url,pageTitle:tab.title,tabId:tab.id}
if('mediaType'in info&&info.mediaType==='image'&&'srcUrl'in info){shareObj.mediaUrl=info.srcUrl;}
Share.sharePage(shareObj.targetName,shareObj.pub,shareObj.pageUrl,shareObj.pageTitle,shareObj.tabId);}},_createMenu:function(){this.removeContextMenu();var parentMenu=chrome.contextMenus.create({title:Constants.CONTEXT_MENU_TITLE,contexts:["page","frame","link","editable","image","video","audio"]});var targets={};targets=Preferences.getPreferredServicesDetails();for(var name in targets){var target=targets[name];if(target.name=="live"){target.prompt="Live";}
var childContextMenu=chrome.contextMenus.create({title:Util.escapeHTMLEncode(target.prompt),onclick:this._shareFromContextMenu,parentId:parentMenu,contexts:["all"]});this.contextArray[childContextMenu]=new this.contextMenuItems(childContextMenu,target.name);}
var childMoreContextMenu=chrome.contextMenus.create({title:"More",onclick:this._shareFromContextMenu,parentId:parentMenu,contexts:["all"]});this.contextArray[childMoreContextMenu]=new this.contextMenuItems(childMoreContextMenu,"more");var separatorContext=chrome.contextMenus.create({type:"separator",parentId:parentMenu});var childOptionsContextMenu=chrome.contextMenus.create({title:"Options",onclick:function(info,tab){chrome.tabs.create({url:"../html/ATX.chrome.options.html"});},parentId:parentMenu});},removeContextMenu:function(){chrome.contextMenus.removeAll();}};var ATX=ATX||{};ATX.contextMenu={contextSearch:function(info,tab){if(typeof info.selectionText!=='undefined'){ATX.search.doSearch(info.selectionText,"ctx");}},selectionSummary:function(text){ATX.log('contextMenu.selectionSummary()');ATX.test(typeof text==="string");var length=18;if(text.length>length){text=text.substring(0,length-3)+'...';}
text='Search for "'+text+'"';return text;},initialize:function(){ATX.log("contextMenu.initialize");chrome.contextMenus.removeAll();if(localStorage["context_menu"]==="true"){ContextMenu._createMenu();}
if(localStorage["context_menu_search"]==="true"){var that=this;var itemObject={"title":"Search for selected text",contexts:["selection"],onclick:ATX.contextMenu.contextSearch};chrome.contextMenus.create(itemObject);}}};