
var BrowserAction={bgPage:chrome.extension.getBackgroundPage(),authError:false,authService:"",tweetRandomUrl:"",load:function(){BrowserAction._setIcon();BrowserAction._setEventHandlers();window.setTimeout(function(){BrowserAction._createShareMenu('sharemenu');},100);BrowserAction._setTwitterImage();BrowserAction._setFaceBookImage();},_setEventHandlers:function(){$("#txtFacebookComment").focus(function(){$("#txtFacebookComment").val("");$('#txtFacebookComment').unbind('focus');});$("#txtTwitterComment").keyup(function(event){BrowserAction._manipulateTweetEntry();});},_setIcon:function(){setTimeout(function(){chrome.browserAction.setIcon({path:chrome.extension.getURL('images/19x19-full.png')});},100);},_injectContentScript:function(){BrowserAction.bgPage.BootLoader.injectContentScript(null);},authenticateSocialService:function(service){if(this.authService=="facebook")
this.bgPage.FBHandler.authenticate();else{$("#btnAuthSend").html("<span></span>");$('#btnAuthSend').addClass("loading");this.bgPage.TwitterHandler.getToken();}},shareThisPage:function(targetName){if(targetName=="facebook"&&this.bgPage.FBHandler.isSession&&this.bgPage.Preferences.isSocialServices()&&this.bgPage.Preferences.isFBAuthPreference()){$("#txtFacebookComment").css("display","block");$("#spnFBSuccess").css("display","none");this.ToggleOAuthScreen("FBScreen");}else if(targetName=="facebook"&&this.bgPage.Preferences.isSocialServices()&&!this.bgPage.FBHandler.isSession&&this.bgPage.Preferences.isFBAuthPreference()){this.ToggleOAuthScreen("divOAuthMessage","facebook");this.authService="facebook";}else if(targetName=="twitter"&&this.bgPage.TwitterHandler.isSession&&this.bgPage.Preferences.isSocialServices()&&this.bgPage.Preferences.isTwitterAuthPreference()){$("#txtTwitterComment").css("display","block");$("#spnTwitterSuccess").css("display","none");this.ToggleOAuthScreen("tweetScreen");}else if(targetName=="twitter"&&!this.bgPage.TwitterHandler.isSession&&this.bgPage.Preferences.isSocialServices()&&this.bgPage.Preferences.isTwitterAuthPreference()){this.ToggleOAuthScreen("divOAuthMessage","twitter");this.authService="twitter";}else{chrome.windows.getCurrent(function(focusedWindow){var focusedWindowId=focusedWindow.id;chrome.tabs.getSelected(focusedWindowId,function(tab){BrowserAction.bgPage.Share.sharePage(targetName,(typeof(BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id])!="undefined"&&BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id])?BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id]:"",tab.url,tab.title,tab.id);});});}},showOptions:function(args){var optionsUrl="../html/ATX.chrome.options.html";if((typeof(args!=='undefined')&&args))
optionsUrl+="?args="+args;chrome.tabs.create({url:optionsUrl});},_createShareMenu:function(divId){var shareDoc=document;var menuDiv=shareDoc.getElementById(divId);if(menuDiv&&(typeof(menuDiv)!="undefined")){var targets={};targets=BrowserAction.bgPage.Preferences.getPreferredServicesDetails();chrome.windows.getCurrent(function(focusedWindow){var focusedWindowId=focusedWindow.id;chrome.tabs.getSelected(focusedWindowId,function(tab){for(var name in targets){var target=targets[name];var targetItem;if(target.name=="facebook_like"){targetItem=document.createElement('div');targetItem.setAttribute('class',"addthis-iframe-fb");$(targetItem).append('<iframe src="http://www.facebook.com/plugins/like.php?href='+encodeURIComponent(tab.url)+'&amp;send=false&amp;layout=button_count&amp;width=100&amp;show_faces=false&amp;action=like&amp;colorscheme=light&amp;font&amp;height=21" scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:100px; height:21px;" allowTransparency="true"></iframe>');menuDiv.appendChild(targetItem);menuDiv.style.height="302px";}else if(target.name=="google_plusone"){targetItem=document.createElement('div');targetItem.setAttribute('class',"addthis-iframe-google");$(targetItem).append('<div class="g-plusone" data-size="small" data-annotation="bubble" data-width="120" data-href="'+tab.url+'"></div>');menuDiv.appendChild(targetItem);var script=document.createElement("script");script.type="text/javascript";script.src="https://apis.google.com/js/plusone.js";document.head.appendChild(script);if(menuDiv.style.height!=="302px"){menuDiv.style.height="293px";}}else if(target.name&&target.name!="google_plusone"){if(target.name=="live"){target.prompt="Live";}
var targetImg=document.createElement('img');targetImg.setAttribute("src",target.icon16Url);targetItem=document.createElement('div');targetItem.setAttribute("id","at_dp_"+target.name);targetItem.setAttribute('class',"menu-target-item");targetItem.setAttribute('href',"");targetItem.setAttribute('title',target.prompt);targetItem.setAttribute('onclick',"BrowserAction.shareThisPage('"+target.name+"');");targetItem.appendChild(targetImg);$(targetItem).append('<span>'+target.prompt+'</span>');menuDiv.appendChild(targetItem);}}
$('#sharemenu').append('<div id="at_dp_more" class="menu-target-item" href="" title="More Sharing Destinations" onclick="BrowserAction.shareThisPage(\'more\');"><img src="https://cache.addthiscdn.com/icons/v1/thumbs/more.gif"><span>More...</span></div>');$('#sharemenu').append('<div id="footer"><div id="options" title="Configure Services" onclick="BrowserAction.showOptions();return false;">Options</div></div>');$('[id^=at_dp_]').bind('click',function(){var get_service=this.id;get_service=get_service.split("at_dp_");BrowserAction.shareThisPage(get_service[1]);return false;});$('#options').bind('click',function(){BrowserAction.showOptions();return false;});$(".menu-target-item").hover(function(evt){$(this).addClass("menu-item-selected");},function(evt){$(this).removeClass("menu-item-selected");});});});}},ToggleOAuthScreen:function(screenID,service){if($('#'+screenID).css('display')=='none'){$('#sharemenu').fadeOut('fast',function(){$('html').height(90);$('body').height(90);$('#'+screenID).fadeIn('fast');if(screenID=="tweetScreen"){BrowserAction.oAuthShare("twitter","show");}
else if(screenID=="divOAuthMessage"){if(service==='facebook'){$("#imgAuth").attr("src","../images/facebook_icon-48.png");}else{$("#imgAuth").attr("src","../images/twitter_icon-48.png");}}
else if(screenID=="FBScreen"){$('html').height(200);$('body').height(200);chrome.windows.getCurrent(function(focusedWindow){var focusedWindowId=focusedWindow.id;chrome.tabs.getSelected(focusedWindowId,function(tab){var data=BrowserAction.bgPage.FBHandler.metaData[tab.id];if((typeof(data)!=="undefined"&&data)){$("#titleFBPreview").html((typeof(data.title)!=='undefined'&&data.title)?data.title:tab.title);$("#urlFBPreview").html((typeof(data.url)!=='undefined'&&data.url)?data.url:tab.url);$("#descriptionFBPreview").html((typeof(data.description)!=='undefined'&&data.description)?data.description:"");$("#imgFBPreview").hide();$('.atpop-content-preview').addClass('no-scrape');if(typeof data.image!=="undefined"){if(typeof data.image==="string"){if(data.image.length>3){$('.atpop-content-preview').removeClass('no-scrape');$("#imgFBPreview").attr("src",data.image);$("#imgFBPreview").show();}}}}else{$("#imgFBPreview").hide();$('.atpop-content-preview').addClass('no-scrape');$("#titleFBPreview").html(tab.title);$("#urlFBPreview").html(tab.url);}});});}});}else{if(screenID=="divOAuthMessage"){if(this.authService=="facebook"){BrowserAction.bgPage.Preferences.setFBAuthPreference(false);BrowserAction.shareThisPage("facebook");}
else{BrowserAction.bgPage.Preferences.setTwitterAuthPreference(false);BrowserAction.shareThisPage("twitter");}}
$('#'+screenID).fadeOut('fast',function(){self.close();window.open('','_self','');window.close();chrome.tabs.getSelected(null,function(tab){chrome.tabs.update(tab.id,{selected:true});});});}},showShareMenu:function(){$('#FBScreen,#tweetScreen').fadeOut('slow',function(){$('#sharemenu').fadeIn('slow');});},oAuthShare:function(service,type){var tweetText;chrome.windows.getCurrent(function(focusedWindow){var focusedWindowId=focusedWindow.id;chrome.tabs.getSelected(focusedWindowId,function(tab){if(service=="facebook"){$("#btnFacebookSend").html("<span></span>");$('#btnFacebookSend').addClass("loading");BrowserAction.bgPage.FBHandler.post(tab.url,$('#txtFacebookComment').val(),tab.title,(typeof(BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id])!="undefined"&&BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id])?BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id]:"");}
else if(service=="twitter"){if(!BrowserAction.bgPage.TwitterHandler.isSession){$("#spnTweetCount").append("Check your system date");BrowserAction.authError=false;$("#divOAuthMessage,#twitPic,#txtTwitterComment,#btn-cancel,#btnTwitterSend").css("display","none");}
else if(type=="show"){if($("#twitPic,#txtTwitterComment,#btn-cancel,#btnTwitterSend").css("display")=="none")
$("#twitPic,#txtTwitterComment,#btn-cancel,#btnTwitterSend").css("display","block");BrowserAction.tweetRandomUrl=BrowserAction.bgPage.Util.randomString(7);tweetText=tab.title+": http://t.co/"+BrowserAction.tweetRandomUrl+" via @AddThis";$("#txtTwitterComment").val(tweetText);$("#spnTweetCount").html(tweetText.length);BrowserAction._manipulateTweetEntry();}else{tweetText=$("#txtTwitterComment").val();if(tweetText.length<=140){$("#btnTwitterSend").html("<span></span>");$('#btnTwitterSend').addClass("loading");BrowserAction.bgPage.TwitterHandler.post(($("#txtTwitterComment").val().replace("http://t.co/"+BrowserAction.tweetRandomUrl,tab.url)),tab.url,tab.title,(typeof(BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id])!="undefined"&&BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id])?BrowserAction.bgPage.BootLoader.pubIDTabMap[tab.id]:"");}
else{$("#spnTweetCount").addClass("countwarning");}}}});});},setButtonCSS:function(btnID,status,shareData){if(status=="Success"){$("#"+btnID).html("Sent!");$("#"+btnID).removeClass("loading");$("#"+btnID).addClass("sent");if(btnID=="btnFacebookSend"){$("#aFBSuccess").attr("href","javascript:BrowserAction.openUrl('"+BrowserAction.bgPage.FBHandler.link+"')");$("#txtFacebookComment").css("display","none");$("#spnFBSuccess").css("display","block");setTimeout(function(){BrowserAction.ToggleOAuthScreen('FBScreen');},2000);}
else if(btnID=="btnTwitterSend"){$("#txtTwitterComment").css("display","none");$("#spnTwitterSuccess").css("display","block");setTimeout(function(){BrowserAction.ToggleOAuthScreen('tweetScreen');},2000);}}else{if(btnID=="btnTwitterSend"){if(status=="Timebound"){$("#spnTweetCount").html("Check your system date");setTimeout(function(){BrowserAction.ToggleOAuthScreen('tweetScreen');},3000);}else if(status=="Duplicate"){$("#spnTweetCount").html("Duplicate Tweet");}else if(status=="Error Timestamp"){BrowserAction.authError=true;BrowserAction.ToggleOAuthScreen("tweetScreen");}
else{$("#spnTweetCount").html("Duplicate Tweet");setTimeout(function(){BrowserAction.ToggleOAuthScreen('tweetScreen');},3000);}
$("#spnTweetCount").addClass("countwarning");$("#"+btnID).removeClass("loading");$("#"+btnID).html("Tweet");}else if(btnID=="btnFacebookSend"){if(status=="urlError"){$("#spnFBMessage").html("Invalid URL");}else{$("#spnFBMessage").html("Error in Posting");setTimeout(function(){BrowserAction.ToggleOAuthScreen('FBScreen');},300);}
$("#spnFBMessage").addClass("countwarning");$("#"+btnID).removeClass("loading");$("#"+btnID).html("Share");}}},_dummyHandler:function(){this.setButtonCSS("btnTwitterSend");},_setTwitterImage:function(){$("#twitPic").attr("src",(this.bgPage.TwitterHandler.avatarImageUrl&&this.bgPage.TwitterHandler.avatarImageUrl!=="")?this.bgPage.TwitterHandler.avatarImageUrl:"../images/loading-gear.gif");},_setFaceBookImage:function(){$("#fbPic").attr("src",(this.bgPage.FBHandler.avatarImageUrl&&this.bgPage.FBHandler.avatarImageUrl!=="")?this.bgPage.FBHandler.avatarImageUrl:"../images/loading-gear.gif");},_manipulateTweetEntry:function(){var tweetCount=$("#txtTwitterComment").val().length;$("#spnTweetCount").html(140-tweetCount);if(tweetCount>140){$("#spnTweetCount").addClass("countwarning");}
else{$("#spnTweetCount").hasClass("countwarning")?$("#spnTweetCount").removeClass("countwarning"):null;}},_getCurrentUrl:function(){chrome.windows.getCurrent(function(focusedWindow){var focusedWindowId=focusedWindow.id;chrome.tabs.getSelected(focusedWindowId,function(tab){return tab.url;});});},openUrl:function(url){chrome.tabs.create({url:url});},hitSubmit:function(e){if(e.charCode==10&&e.ctrlKey==true){if(document.getElementById('FBScreen').style.display!="none"){BrowserAction.oAuthShare('facebook');}else{BrowserAction.oAuthShare('twitter');}}}};$(document).ready(function(){BrowserAction.load();$('#no_thanks').bind('click',function(){BrowserAction.ToggleOAuthScreen('divOAuthMessage');});$('#btnAuthSend').bind('click',function(){BrowserAction.authenticateSocialService();});$('#btnFacebookCancel').bind('click',function(){BrowserAction.ToggleOAuthScreen('FBScreen');});$('#btnFacebookSend').bind('click',function(){BrowserAction.oAuthShare('facebook');});$('#btnTwitterCancel').bind('click',function(){BrowserAction.ToggleOAuthScreen('tweetScreen');});$('#btnTwitterSend').bind('click',function(){BrowserAction.oAuthShare('twitter');});});