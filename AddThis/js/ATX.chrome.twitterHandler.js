
var Track={trackShare:function(targetName,pub,pageUrl,pageTitle){var trackUrl="https://api.addthis.com/oexchange/0.8/shared/"+targetName+"?url="+pageUrl+"&title="+pageTitle+"&pco="+Constants.CHROME_PCO_WITH_SOCIAL;trackUrl+=(pub&&pub!="")?"&username="+pub:"";$.ajax({url:trackUrl,type:'POST'});}};var TwitterHandler={isSession:false,oAuthToken:"",oAuthTokenSecret:"",oAuthToken1:"",oAuthTokenSecret1:"",screenName:"",avatarImageUrl:"",oAuthVerifier:"",authWindowID:null,authSuccess:false,init:function(){if(localStorage["TwitterOAuthToken"]&&localStorage["TwitterOAuthTokenSecret"]&&localStorage["TwitterOAuthToken"]!=""&&localStorage["TwitterOAuthTokenSecret"]!=""){TwitterHandler.isSession=true;TwitterHandler.oAuthToken1=localStorage["TwitterOAuthToken"];TwitterHandler.oAuthTokenSecret1=localStorage["TwitterOAuthTokenSecret"];TwitterHandler.screenName=localStorage["screenName"];TwitterHandler.avatarImageUrl=localStorage["TwitterAvatarImage"];}},oAuthRequest:function(url,parameters,type,info){ATX.log('TwitterHandler.oAuthRequest');var signatures={consumer_key:'WJ67WagqzQK7txgWpIrQ',shared_secret:'OI83hSLdi0eo2SefVcgcw7YjijKBlZTFCklEO2NxSk'};if(TwitterHandler.oAuthToken1&&TwitterHandler.oAuthTokenSecret1){signatures.oauth_token=TwitterHandler.oAuthToken1;signatures.access_secret=TwitterHandler.oAuthTokenSecret1;}
var authLink=OAuthSimple().sign({path:url,parameters:parameters,signatures:signatures});if(type=="requestToken"){ATX.log('TwitterHandler.requestToken');var tokenURL=authLink.signed_url;$.ajax({url:tokenURL,type:'POST',success:function(data){ATX.log('TwitterHandler.requestToken SUCCESS');var vars=data.split("&");TwitterHandler.oAuthToken=vars[0].split("=")[1];TwitterHandler.oAuthTokenSecret=vars[1].split("=")[1];TwitterHandler.authSuccess=true,TwitterHandler.oAuthRequest("https://api.twitter.com/oauth/authorize",{oauth_token:TwitterHandler.oAuthToken},"getVerifier");},statusCode:{401:function(){ATX.log('oAuthRequest.requestToken FAIL');BootLoader.makePopupCall("btnTwitterSend","Error Timestamp");}}});setTimeout("TwitterHandler.checkAuth()","6000");}
else if(type=="getVerifier"){ATX.log('TwitterHandler.getVerifier');var accessURL=url+"?oauth_token="+parameters.oauth_token;chrome.windows.create({url:accessURL,width:700,height:500},function(window){TwitterHandler.authWindowID=window.id;});}else if(type=="accessToken"){ATX.log('TwitterHandler.accessToken');var accessURL=authLink.signed_url;$.ajax({url:accessURL,success:function(data){ATX.log('TwitterHandler.accessToken SUCCESS');var vars=data.split("&");TwitterHandler.oAuthToken1=vars[0].split("=")[1];TwitterHandler.oAuthTokenSecret1=vars[1].split("=")[1];TwitterHandler.screenName=vars[3].split("=")[1];localStorage["TwitterOAuthToken"]=TwitterHandler.oAuthToken1;localStorage["TwitterOAuthTokenSecret"]=TwitterHandler.oAuthTokenSecret1;localStorage["screenName"]=TwitterHandler.screenName;TwitterHandler.isSession=true;TwitterHandler.createAvatarImageUrl();}});}else if(type=="postStatus"){ATX.log('TwitterHandler.postStatus');var postURL=authLink.signed_url;$.ajax({url:postURL,type:'POST',success:function(data){ATX.log('TwitterHandler.postStatus SUCCESS');BootLoader.makePopupCall("btnTwitterSend","Success",{id:data.id});Track.trackShare("twitter",info.pubid,info.url,info.title);},error:function(data){ATX.log('TwitterHandler.postStatus FAIL');if(eval('('+data.responseText+')').error=="Status is a duplicate.")
BootLoader.makePopupCall("btnTwitterSend","Duplicate");else if(eval('('+data.responseText+')').error=="Timestamp out of bounds")
BootLoader.makePopupCall("btnTwitterSend","Timebound");else if(eval('('+data.response+')').error=="Could not authenticate with OAuth."){TwitterHandler.cleanAuthDetails();BootLoader.makePopupCall("btnTwitterSend","oAuthError");}},statusCode:{403:function(){ATX.log('TwitterHandler.postStatus FAIL');BootLoader.makePopupCall("btnTwitterSend","Error");}}});}else if(type=="getUserDetails"){ATX.log('TwitterHandler.getUserDetails');var postURL=authLink.signed_url;$.ajax({url:postURL,success:function(data){ATX.log('TwitterHandler.getUserDetails SUCCESS');TwitterHandler.avatarImageUrl=data.profile_image_url;localStorage["TwitterAvatarImage"]=TwitterHandler.avatarImageUrl;BootLoader.makeOptionsCall("btnOAuthTwitter","success");BootLoader.makePageCall("twitter");}});}},getToken:function(){ATX.log('TwitterHandler.getToken');TwitterHandler.authSuccess=false;this.oAuthRequest("https://api.twitter.com/oauth/request_token",{oauth_callback:"http://www.addthis.com/pages/twitter-auth-callback",oauth_version:"1.0"},"requestToken",{});},getAccessToken:function(pin){ATX.log('TwitterHandler.getAccessToken');this.oAuthRequest("https://api.twitter.com/oauth/access_token",{"oauth_verifier":pin,oauth_version:"1.0",oauth_token:TwitterHandler.oAuthToken},"accessToken",{});},post:function(tweet,url,title,pubID){ATX.log('TwitterHandler.post');this.oAuthRequest("https://api.twitter.com/1/statuses/update.json",{status:tweet,wrap_links:true},"postStatus",{url:url,title:title,pubid:pubID});},createAvatarImageUrl:function(){ATX.log('TwitterHandler.createAvatarImageUrl');this.oAuthRequest("https://api.twitter.com/1/account/verify_credentials.json",{oauth_version:"1.0"},"getUserDetails",{});},cleanAuthDetails:function(){ATX.log('TwitterHandler.cleanAuthDetails');TwitterHandler.isSession=false;TwitterHandler.oAuthToken1="";localStorage["TwitterOAuthToken"]="";TwitterHandler.oAuthTokenSecret1="";localStorage["TwitterOAuthTokenSecret"]="";TwitterHandler.screenName="";localStorage["screenName"]="";TwitterHandler.avatarImageUrl="";localStorage["TwitterAvatarImage"]="";},checkAuth:function(){ATX.log('TwitterHandler.checkAuth');if(!TwitterHandler.authSuccess){BootLoader.makePopupCall("btnTwitterSend","Error Timestamp");BootLoader.makeOptionsCall("btnOAuthTwitter","Error Timestamp");}}};